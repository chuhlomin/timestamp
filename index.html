<html>
<head>
    <title>Timestamp</title>
    <style>
      body {
        font-family: --apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: #2E2F30;
      }
      h1 {
        position: relative;
        width: 640px;
        margin: 0rem auto;
        text-align: left;
        font-family: --apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-weight: bold;
        font-size: 3rem;
        margin-top: 4rem;
        margin-bottom: 1rem;
        color: #666;
        text-shadow: 0 1px 0px rgba(0,0,0,0.15);
      }
      #app {
        width: 640px;
        margin: 0rem auto;
      }
      input {
        font-family: "Pragmata Pro", "SF Mono", monospace;
        font-size: 2rem;
        width: 100%;
      }
      input[type="text"] {
        margin: 0;
        border-radius: 4px;
      }
      button {
        font-size: 1rem;
        color: #E0E5DC;
        background-color: #6C6C6C;
        border: none;
        border-radius: 4px;
        box-shadow: 0 1px 1px rgba(255,255,255,0.3) inset,
          0 1px 1px rgba(0,0,0,0.3);
        padding: 0.33rem 0.8rem;
      }
      button:active {
        background: #868586;
      }
      div + div {
        margin-top: 1rem;
      }
      span {
        display: inline-block;
        margin-bottom: 0.33rem;
        color: #999;
      }
      .input {
        display: flex;
      }
      .input input {
        border: 1px solid #4F4E4F;
        border-right: 0;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        z-index: 10;
        background: #454545;
        color: #C4C3C0;
      }
      .input input:invalid {
        box-shadow: 0 0px 0px 2px orange;
      }
      .input input[readonly] {
        border: 1px solid #3F3F41;
        cursor: default;
        background: transparent;
        color: #676767;
      }
      .input button {
        margin: 0;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        background: #2E2F30 url("./copy.png") no-repeat center center;
        background-size: 16px 16px;
        color: #A5A5A6;
        border: 1px solid #3F3F41;
        box-shadow: none;
        text-indent: -9000000px;
        padding: 0 1.5rem;
      }
      .input button:active {
        background-color: #222;
      }
      .btnNow {
        position: absolute;
        right: 0;
        bottom: 0;
        font-weight: bold;
      }
    </style>
</head>
<body>
<div id="app">
  <h1>
    Timestamp panel
    <button class="btnNow" v-on:click="now">Now</button>
  </h1>
  <div>
    <label for="unix"><span>Unix Timestamp:</span></label>
    <div class="input">
      <input id="unix" v-model="unix" v-on:keyup="inputChangedUnix" type="text" required v-on:keydown.up="change(1,$event)" v-on:keydown.down="change(-1,$event)"  pattern="-?[\d]+(.[\d]+)?">
      <button v-on:click="copy('unix')" class="copy">Copy</button>
    </div>
  </div>
  <div>
    <label for="unixms"><span>Unix Timestamp with Milliseconds:</span></label>
    <div class="input">
      <input id="unixms" v-model="unixms" v-on:keyup="inputChangedUnixMs" type="text" required pattern="-?\d+">
      <button v-on:click="copy('unixms')" class="copy">Copy</button>
    </div>
  </div>
  <div>
    <label for="utc"><span>UTC:</span></label>
    <div class="input">
      <input id="utc" v-model="utc" v-on:keyup="inputChangedUTC" type="text" required v-on:keydown.up="changeUTC(1,$event)" v-on:keydown.down="changeUTC(-1,$event)" required pattern="[a-zA-Z]{3}, \d{2} [a-zA-Z]{3} -?\d{1,4} \d{2}:\d{2}:\d{2} GMT">
      <button v-on:click="copy('utc')" class="copy">Copy</button>
    </div>
  </div>
  <div>
    <label for="iso"><span>ISO:</span></label>
    <div class="input">
      <input id="iso" v-model="iso" v-on:keyup="inputChangedISO" type="text" required v-on:keydown.up="changeISO(1,$event)" v-on:keydown.down="changeISO(-1,$event)" pattern="\d{1,4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z">
      <button v-on:click="copy('iso')" class="copy">Copy</button>
    </div>
  </div>
  <div>
    <label for="locale"><span>Locale:</span></label>
    <div class="input">
      <input id="locale" v-model="locale" type="text" readonly>
      <button v-on:click="copy('locale')" class="copy">Copy</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
var ts = new Date();
const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"]
const utcValueMeaning = ["dow", "day", "month", "year", "hour", "min", "sec", "zone"]
const isoValueMeaning = ["year", "month", "day", "hour", "min", "sec", "msec"]

var bounds = new Map()
bounds.set("msec", [0, 999, "sec"])
bounds.set("sec", [0, 59, "min"])
bounds.set("min", [0, 59, "hour"])
bounds.set("hour", [0, 23, "day"])
bounds.set("day", [1, undefined, "month"]) // day has a special logic
bounds.set("month", [1, months.length, "year"])

var formatUnix = function(unix) {
  var parts = unix.split(".")
  if (parts.length != 2) {
    return unix
  }
  while (parts[1].length < 3) {
    parts[1] += '0'
  }
  return parts.join('.')
};

var daysInMonth = function(month, year) {
    return new Date(year, month, 0).getDate();
}

var capitalizeFirstLetter = function(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

var updateVal = function(format, parts, name, diff) {
  console.log(name, diff)
  let valueMeaning = getValueMeaningMap(format)

  ind = valueMeaning.indexOf(name)

  if (format == "utc" && name == "month") {
    val = months.indexOf(parts[ind].toLowerCase()) + diff
  } else if (name == "year" && parseInt(parts[ind], 10) == 100 && diff == -1) {
    return
  } else {
    val = (parseInt(parts[ind], 10) + diff).toString()
  }

  shouldUpdateNext = false
  b = bounds.get(name)

  if (b !== undefined) { 
    var min = b[0]
    var max = b[1]

    if (name == "day") {
      currentMonth = months.indexOf(parts[2].toLowerCase());
      prevMonth = currentMonth - 1
      if (prevMonth < 0) {
        prevMonth = 11;
      }
      currentMonthMax = daysInMonth(currentMonth+1, parts[3])
      prevMonthMax = daysInMonth(prevMonth+1, parts[3])

      if (val < min) {
        max = prevMonthMax
      } else if (val > currentMonthMax) {
        max = currentMonthMax
      }
    }
    if (name == "month" && format == "utc") {
      min--
      max--
    }

    if (val < min) {
      val = max
      shouldUpdateNext = true
    } else if (val > max) {
      val = min
      shouldUpdateNext = true
    }
  }
  
  if (format == "utc" && name == "month") {
    parts[ind] = capitalizeFirstLetter(months[val])
  } else {
    parts[ind] = val.toString()
  }

  if (shouldUpdateNext) {
    parts = updateVal(format, parts, b[2], diff)
  }

  return parts
}

var prependZeroToMatchLength = function(val, length) {
  return "0".repeat(length - val.toString().length) + val.toString()
}

var format2 = function(val) { return prependZeroToMatchLength(val, 2)}
var format3 = function(val) { return prependZeroToMatchLength(val, 3)}
var format4 = function(val) { return prependZeroToMatchLength(val, 4)}

var formatUTC = function(parts) {
  return `${parts[0]} ${format2(parts[1])} ${capitalizeFirstLetter(parts[2])} ${format4(parts[3])} ${format2(parts[4])}:${format2(parts[5])}:${format2(parts[6])} ${parts[7]}`
}

var formatISO = function(parts) {
  console.log(parts)
  return `${format4(parts[0])}-${format2(parts[1])}-${format2(parts[2])}T${format2(parts[3])}:${format2(parts[4])}:${format2(parts[5])}.${format3(parts[6])}Z`
}

var getValueMeaningMap = function(format) {
  switch (format) {
    case "iso":
      return isoValueMeaning
    case "utc":
      return utcValueMeaning
    default:
      return []
  }
}

var app = new Vue({
  el: '#app',
  data: {
    unix: formatUnix((ts.getTime()/1000).toString()),
    unixms: ts.getTime().toString(),
    utc: ts.toUTCString(),
    iso: ts.toISOString(),
    locale: ts.toLocaleString(),
  },
  methods: {
    inputChangedUnix: function (e) {
      if (!e.target.checkValidity()) {
        return
      }

      var parts = this.unix.split(".")
      if (parts.length == 2) {
        while (parts[1].length < 3) {
          parts[1] += '0'
        }
      }

      ts = new Date();
      ts.setTime(parts[0] * 1000 + (parts[1]|0));
      
      this.utc = ts.toUTCString();
      this.unixms = ts.getTime().toString();
      this.iso = ts.toISOString();
      this.locale = ts.toLocaleString();
    },
    inputChangedUnixMs: function (e) {
      if (!e.target.checkValidity()) {
        return
      }

      ts = new Date();
      ts.setTime(this.unixms);
      
      this.unix = formatUnix((ts.getTime()/1000).toString());
      this.utc = ts.toUTCString();
      this.iso = ts.toISOString();
      this.locale = ts.toLocaleString();
    },
    inputChangedUTC: function(e) {
      if (!e.target.checkValidity()) {
        return
      }

      var parts = e.target.value.split(" ");
      var hourParts = parts[4].split(":");

      month = months.indexOf(parts[2].toLowerCase())
      if (month == -1) {
        return
      }
      
      ts = new Date(Date.UTC(
        parts[3],
        month,
        parts[1],
        hourParts[0],
        hourParts[1],
        hourParts[2],
        0,
      ))

      this.unix = formatUnix((ts.getTime()/1000).toString());
      this.unixms = ts.getTime().toString();
      this.iso = ts.toISOString();
      this.locale = ts.toLocaleString();

      var selectionStart = e.target.selectionStart
      var selectionEnd = e.target.selectionEnd

      newDayOfWeek = ts.toUTCString().split(",")[0]
      this.utc = newDayOfWeek + "," + this.utc.split(",")[1]

      Vue.nextTick(function () {
        document.getElementById('utc').setSelectionRange(selectionStart, selectionEnd)
      })
    },
    inputChangedISO: function(e) {
      if (!e.target.checkValidity()) {
        return
      }

      var parts = e.target.value.split("T");
      var dateParts = parts[0].split("-");
      var hourParts = parts[1].split(":");
      var minutesParts = hourParts[2].split(".");

      ts = new Date(Date.UTC(
        dateParts[0],
        (dateParts[1]-1),
        dateParts[2],
        hourParts[0],
        hourParts[1],
        minutesParts[0],
        minutesParts[1].substring(0, 3),
      ))

      this.unix = formatUnix((ts.getTime()/1000).toString());
      this.unixms = ts.getTime().toString();
      this.utc = ts.toUTCString();
      this.locale = ts.toLocaleString();
    },
    now: function() {
      ts = new Date();

      this.unix = formatUnix((ts.getTime()/1000).toString());
      this.unixms = ts.getTime().toString();
      this.utc = ts.toUTCString();
      this.iso = ts.toISOString();
      this.locale = ts.toLocaleString();
    },
    copy: function(input) {
      var el = document.getElementById(input)
      var selectionStart = el.selectionStart
      var selectionEnd = el.selectionEnd
      el.select();
      document.execCommand("copy");
      el.selectionStart = selectionStart;
      el.selectionEnd = selectionEnd;
    },
    getValueIndex: function(parts, selectionStart) {
      var valueStopIndex = 0
      var currentLength = 0;
      
      for (var i = 0; i < parts.length; i++) { // iterate over words
        valueStopIndex = currentLength + parts[i].length;
        currentLength = valueStopIndex + 1 // +1 for separator
        
        if (selectionStart < currentLength) { // if cursor is on current word
          return i
        }
      }

      return -1
    },
    changeUTC: function(diff, e) {
      e.preventDefault();
      e.stopPropagation();
      if (!e.target.checkValidity()) {
        return
      }

      var selectionStart = e.target.selectionStart;
      var selectionEnd = e.target.selectionEnd
      var parts = e.target.value.split(/[\s:]+/); // separate by space or colon
      
      let valueIndex = this.getValueIndex(parts, selectionEnd)
      if (valueIndex == -1) {
        console.log("valueIndex = -1, this should never happen")
        return
      }

      var valueMeaning = this.getValueMeaningUTC(valueIndex)
      if (valueMeaning == "zone") {
        console.log("Time Zone update not supported",)
        return
      }
      if (valueMeaning == "dow") {
        valueMeaning = "day"
      }

      parts = updateVal("utc", parts, valueMeaning, diff)
      this.utc = formatUTC(parts)
      Vue.nextTick(function () {
        document.getElementById('utc').setSelectionRange(selectionStart, selectionEnd)
      })
    },
    changeISO: function(diff, e) {
      e.preventDefault();
      e.stopPropagation();
      if (!e.target.checkValidity()) {
        return
      }

      var selectionStart = e.target.selectionStart;
      var selectionEnd = e.target.selectionEnd
      var parts = e.target.value.split(/[-:TZ\.]+/); // separate by "-", ":", "T", "." or "Z"

      let valueIndex = this.getValueIndex(parts, selectionEnd)
      if (valueIndex == -1) {
        console.log("valueIndex = -1, this should never happen")
        return
      }

      var valueMeaning = this.getValueMeaningISO(valueIndex)
      if (valueMeaning == "zone") {
        console.log("Time Zone update not supported",)
        return
      }

      parts = updateVal("iso", parts, valueMeaning, diff)
      this.iso = formatISO(parts)
      Vue.nextTick(function () {
        document.getElementById('iso').setSelectionRange(selectionStart, selectionEnd)
      })
    },
    getValueMeaningUTC: function(index) {
      return utcValueMeaning[index]
    },
    getValueMeaningISO: function(index) {
      return isoValueMeaning[index]
    }
  }
})
</script>
</body>
</html>
